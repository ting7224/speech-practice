<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ä¸­æ–‡å£èªç·´ç¿’</title>
  <style>
    body {
      font-family: "Microsoft JhengHei", Arial, sans-serif;
      background: #fafafa;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 920px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1 { text-align: center; color: #333; margin-top: 0; }
    h2 { margin-top: 28px; }
    select, button { padding: 8px 12px; margin: 5px; font-size: 16px; }
    .sentence {
      font-size: 20px; text-align: center; margin: 20px 0;
      padding: 10px; background: #f1f1f1; border-radius: 8px;
    }
    #result, #diff, #quizDiff, .box {
      padding: 10px; margin-top: 10px; background: #f9f9f9;
      border: 1px solid #ddd; min-height: 30px; border-radius: 8px;
    }
    .row { margin: 6px 0; }
    .label { color:#666; font-size:14px; margin-right:6px; }
    .highlight { background: yellow; font-weight: bold; }
    .ok { background: rgba(22,163,74,.12); }
    .note { color:#6b7280; font-size:12px; }
    .scoreRow { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    #feedback { color:#374151; font-size:15px; }
    .muted { color:#6b7280; }
    .flex { display:flex; gap:20px; flex-wrap:wrap; }
    .col { flex:1 1 380px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eaeaea; padding: 8px; text-align: left; vertical-align: top; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .em { font-weight:600; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ä¸­æ–‡å£èªå³æ™‚æ¯”å°</h1>

    <!-- ç·´ç¿’æ¨¡å¼ -->
    <h2>ç·´ç¿’</h2>
    <div class="flex">
      <div class="col">
        <div class="actions">
          <label for="topic">é¸æ“‡ä¸»é¡Œï¼š</label>
          <select id="topic">
            <option value="school">å­¸æ ¡</option>
            <option value="transport">äº¤é€š</option>
            <option value="shopping">è³¼ç‰©</option>
            <option value="food">é¤é£²</option>
            <option value="housing">ä½å®¿</option>
          </select>
          <button onclick="newSentence()">æ›ä¸€å¥</button>
        </div>

        <div class="sentence" id="sentence">è«‹æŒ‰ã€Œæ›ä¸€å¥ã€ç”Ÿæˆå¥å­</div>

        <div class="actions">
          <button onclick="playSentence()">ğŸ”Š ç¤ºç¯„ç™¼éŸ³</button>
          <button onclick="startRecognition()">ğŸ™ï¸ é–‹å§‹éŒ„éŸ³</button>
        </div>

        <h3>è¾¨è­˜çµæœï¼š</h3>
        <div id="result">å°šç„¡çµæœ</div>

        <h3>å·®ç•°é«˜å…‰ï¼š</h3>
        <div id="diff">å°šç„¡çµæœ</div>
        <div class="note">èªªæ˜ï¼šç¶ åº•ç‚ºä¸€è‡´ï¼Œé«˜å…‰ç‚ºä¸åŒï¼›ä¾‹å¥ç¼ºæ¼ä»¥ <b>âˆ…</b> é¡¯ç¤ºï¼Œè¾¨è­˜å¤šå”¸æœƒåœ¨ã€Œè¾¨è­˜ã€è¡Œä»¥é«˜å…‰é¡¯ç¤ºã€‚</div>

        <h3>æ­£ç¢ºç‡ï¼š</h3>
        <div class="scoreRow">
          <div id="accuracy">â€”</div>
          <div id="feedback"></div>
          <button id="btnDownload" onclick="downloadTxt()">â¬‡ï¸ ä¸‹è¼‰æˆç¸¾ï¼ˆTXTï¼‰</button>
        </div>
      </div>

      <!-- æ¸¬é©—æ¨¡å¼ -->
      <div class="col">
        <h2>æ¸¬é©—</h2>
        <div class="box">
          <div class="actions">
            <label for="quizTopic">ä¸»é¡Œï¼š</label>
            <select id="quizTopic">
              <option value="school">å­¸æ ¡</option>
              <option value="transport">äº¤é€š</option>
              <option value="shopping">è³¼ç‰©</option>
              <option value="food">é¤é£²</option>
              <option value="housing">ä½å®¿</option>
            </select>
            <button onclick="startQuiz()">é–‹å§‹æ¸¬é©—ï¼ˆ3é¡Œï¼‰</button>
          </div>

          <div class="muted">ç‹€æ…‹ï¼š<span id="quizState">æœªé–‹å§‹</span></div>

          <div class="sentence" id="quizSentence">ï¼ˆé–‹å§‹å¾Œé¡¯ç¤ºæœ¬é¡Œå¥å­ï¼‰</div>

          <div class="actions">
            <button onclick="quizPlay()">ğŸ”Š ç¤ºç¯„ç™¼éŸ³</button>
            <button onclick="quizRecord()">ğŸ™ï¸ é–‹å§‹éŒ„éŸ³</button>
            <button onclick="quizSubmit()">æäº¤æœ¬é¡Œ</button>
          </div>

          <div class="row"><span class="label">æœ¬é¡Œè¾¨è­˜ï¼š</span><span id="quizHeard">â€”</span></div>
          <div id="quizDiff">ï¼ˆé«˜å…‰å·®ç•°æœƒé¡¯ç¤ºåœ¨é€™è£¡ï¼‰</div>
        </div>

        <div id="quizSummary" class="box" style="display:none;">
          <h3>æœ¬æ¬¡æ¸¬é©—çµæœ</h3>
          <div class="row">ç¸½æ­£ç¢ºç‡ï¼š<b id="quizTotal">â€”</b></div>
          <div class="row">ç¸½è©•ï¼ˆä¸­ / ENï¼‰ï¼š<span id="quizFeedback" class="em">â€”</span></div>
          <div class="actions">
            <button onclick="downloadQuizTXT()">â¬‡ï¸ ä¸‹è¼‰æœ¬æ¬¡ï¼ˆTXTï¼‰</button>
            <button onclick="downloadQuizCSV()">â¬‡ï¸ ä¸‹è¼‰æœ¬æ¬¡ï¼ˆCSVï¼‰</button>
          </div>

          <h4>è¾¨è­˜æ¯”å°è¡¨ï¼ˆ3é¡Œï¼‰</h4>
          <table id="quizTable">
            <thead>
              <tr>
                <th style="width:40px;">é¡Œ</th>
                <th>ä¾‹å¥ / è¾¨è­˜ï¼ˆé›™è¡Œé«˜å…‰ï¼‰</th>
                <th style="width:80px;">æ­£ç¢ºç‡</th>
              </tr>
            </thead>
            <tbody><!-- JS å‹•æ…‹å¡«å…¥ --></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
  // ---- å¥åº«ï¼šæ¯å€‹ä¸»é¡Œ 5 å¥ ----
  const sentences = {
    school: [
      "è«‹å•æˆ‘å¯ä»¥åœ¨å“ªè£¡è¾¦ç†åŠ é€€é¸",
      "åœ–æ›¸é¤¨ä»Šå¤©é–‹åˆ°å¹¾é»",
      "ä¸‹é€±çš„å°çµ„å ±å‘Šè¦ä¸Šè‡ºå ±å‘Šï¼Œæˆ‘å¾ˆç·Šå¼µ",
      "æ˜å¤©çš„é«”è‚²èª²è¦ç©¿é‹å‹•æœå’Œç™½è‰²çƒé‹",
      "äº¤æ›ç”Ÿèªªæ˜æœƒæ”¹åˆ°æ˜å¤©ï¼Œåˆ¥é²åˆ°äº†"
    ],
    transport: [
      "åˆ°è‡ºåŒ—è»Šç«™è¦åœ¨å“ªè£¡æ­è»Š",
      "è«‹å¾å¾Œé–€ä¸‹è»Šï¼Œä¸è¦æ“ ",
      "é€™ç­å…¬è»Šçš„æœ«ç­è»Šæ˜¯å¹¾é»",
      "ä½ è¦ä¸‹è»Šçš„è©±è«‹è¨˜å¾—æŒ‰ä¸‹è»Šéˆ´",
      "è¦æ­é«˜éµè‡ªç”±åº§éœ€è¦å…ˆæ’éšŠ"
    ],
    shopping: [
      "é€™ä»¶å¤–å¥—æœ‰æ²’æœ‰å°ä¸€è™Ÿçš„",
      "é€™æ˜¯ç‰¹åƒ¹å•†å“ï¼Œå”®å‡ºæ•ä¸é€€æ›",
      "è«‹å•æˆ‘å¯ä»¥ä½¿ç”¨è¡Œå‹•æ”¯ä»˜æˆ–ä¿¡ç”¨å¡å—",
      "è«‹å•ä½ æœ‰æœƒå“¡æˆ–è¼‰å…·å—",
      "é€™ä»¶è¡£æœç ´äº†ä¸€å€‹æ´ï¼Œæˆ‘è¦é€€è²¨"
    ],
    food: [
      "è«‹ä¸è¦åŠ é¦™èœï¼Œè¬è¬ã€‚å¦å¤–åŠ ä¸€é»è¾£",
      "è«‹å•ä½ è¦å…§ç”¨é‚„æ˜¯å¤–å¸¶",
      "æˆ‘è¦é»ä¸€ç¢—ç‰›è‚‰éºµå’Œä¸€æ¯å†°ç´…èŒ¶ï¼Œå…§ç”¨äºŒè™Ÿæ¡Œ",
      "é€™å®¶é¤å»³çš„æ‹›ç‰Œèœæ˜¯å°ç± åŒ…å’Œç‚’é£¯",
      "æˆ‘è¦ä¸€æ¯å†°ç´…èŒ¶ï¼ŒåŠç³–å»å†°"
    ],
    housing: [
      "æˆ‘é€™å€‹å­¸æœŸä¸ä½å®¿èˆï¼Œè¦åœ¨å­¸æ ¡é™„è¿‘ç§Ÿæˆ¿å­",
      "æ°´é›»å¦è¨ˆï¼Œé‚„æœ‰æ¯æœˆç®¡ç†è²»ä¸€ç™¾å…ƒ",
      "é™¤äº†æˆ¿ç§Ÿï¼Œé‚„æœ‰å…©å€‹æœˆçš„æŠ¼é‡‘ï¼Œé€€ç§Ÿçš„æ™‚å€™æœƒé‚„çµ¦ä½ ã€‚",
      "é€™æ£Ÿå¤§æ¨“ä¸å¯ä»¥é¤Šå¯µç‰©ä¹Ÿä¸å¯ä»¥æŠ½è¸",
      "ä¸€å®šè¦åšå¥½åƒåœ¾åˆ†é¡"
    ]
  };

  // ====== å…±ç”¨ï¼šæ™‚é–“ã€æ­£è¦åŒ–ã€æ¯”å° ======
  function nowString(){
    const t = new Date();
    const pad = n => String(n).padStart(2,'0');
    return `${t.getFullYear()}-${pad(t.getMonth()+1)}-${pad(t.getDate())} ${pad(t.getHours())}:${pad(t.getMinutes())}:${pad(t.getSeconds())}`;
  }

  function normalize(str){
    if(!str) return "";
    return str
      .replace(/[\s\p{P}\p{S}]/gu,'') // å»æ‰ç©ºç™½ã€æ¨™é»
      .replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)); // å…¨å½¢è½‰åŠå½¢
  }

  function diffAlign(aRaw, bRaw){
    const a = normalize(aRaw);
    const b = normalize(bRaw);
    const n=a.length, m=b.length;
    const dp = Array.from({length:n+1},()=>Array(m+1).fill(0));
    const bt = Array.from({length:n+1},()=>Array(m+1).fill(null));
    for(let i=0;i<=n;i++){ dp[i][0]=i; bt[i][0]='U'; }
    for(let j=0;j<=m;j++){ dp[0][j]=j; bt[0][j]='L'; }
    for(let i=1;i<=n;i++){
      for(let j=1;j<=m;j++){
        const cost = a[i-1]===b[j-1]?0:1;
        const d = dp[i-1][j-1] + cost; // ä»£æ›¿/ç›¸åŒ
        const u = dp[i-1][j] + 1;      // åˆªé™¤ a
        const l = dp[i][j-1] + 1;      // æ’å…¥ b
        const best = Math.min(d,u,l);
        dp[i][j]=best; bt[i][j] = best===d? 'D' : best===u? 'U' : 'L';
      }
    }
    // å›æº¯
    let i=n, j=m, ops=[];
    while(i>0 || j>0){
      const move=bt[i][j];
      if(move==='D'){
        ops.push({type: a[i-1]===b[j-1]?'EQ':'SUB', a:a[i-1], b:b[j-1]}); i--; j--;
      }else if(move==='U'){
        ops.push({type:'DEL', a:a[i-1], b:''}); i--;
      }else{
        ops.push({type:'INS', a:'', b:b[j-1]}); j--;
      }
    }
    ops.reverse();
    return {distance: dp[n][m], ops, baseLen: Math.max(1,a.length)};
  }

  function feedbackByScore(pct){
    if (pct >= 95) return "å¤ªæ£’äº†ï¼å¹¾ä¹å®Œå…¨æ­£ç¢ºï¼Œç¶­æŒæ¸…æ™°çš„å’¬å­—èˆ‡ç©©å®šçš„èªé€Ÿã€‚";
    if (pct >= 85) return "å¾ˆä¸éŒ¯ï¼å†æ³¨æ„å€‹åˆ¥å­—çš„æ”¶å°¾èˆ‡é€£éŸ³ï¼Œæ”¾æ…¢ä¸€é»æ›´ç©©ã€‚";
    if (pct >= 70) return "æœ‰é€²æ­¥ï¼å»ºè­°å…ˆè·Ÿè‘—ç¤ºç¯„æ…¢é€Ÿæœ—è®€ï¼Œé‡å°é«˜å…‰å­—å¤šç·´å¹¾æ¬¡ã€‚";
    if (pct >= 50) return "åˆ¥æ€¥ï¼Œå…ˆåˆ†æ®µæœ—è®€ä¸¦é‡è¤‡ç·´ç¿’ï¼Œå†å®Œæ•´æœ—è®€ä¸€æ¬¡ã€‚";
    return "åŠ æ²¹ï¼å…ˆè½ç¤ºç¯„å…©éï¼Œé€å­—è·Ÿè®€ï¼Œç¢ºèªæ¯å€‹å­—éƒ½æœ‰ç™¼åˆ°ä½ã€‚";
  }

  // â¶ æ¸¬é©—ç¸½è©•ï¼ˆä¸­ï¼è‹±å°ç…§ï¼‰
  function quizOverallFeedback(totalPct){
    if (totalPct >= 95) return {
      zh: "å¤ªæ£’äº†ï¼å¹¾ä¹å®Œå…¨æ­£ç¢ºï¼Œç¶­æŒæ¸…æ™°çš„å’¬å­—èˆ‡ç©©å®šçš„èªé€Ÿã€‚",
      en: "Excellent! Nearly perfect accuracyâ€”keep your articulation clear and pace steady."
    };
    if (totalPct >= 85) return {
      zh: "å¾ˆä¸éŒ¯ï¼å†æ³¨æ„å€‹åˆ¥å­—çš„æ”¶å°¾èˆ‡é€£éŸ³ï¼Œæ”¾æ…¢ä¸€é»æ›´ç©©ã€‚",
      en: "Great work! Watch final consonants and liaison; a slightly slower pace adds stability."
    };
    if (totalPct >= 70) return {
      zh: "æœ‰é€²æ­¥ï¼å»ºè­°è·Ÿè‘—ç¤ºç¯„æ…¢é€Ÿæœ—è®€ï¼Œé‡å°é«˜å…‰å­—å¤šç·´å¹¾æ¬¡ã€‚",
      en: "Good progress! Shadow the demo slowly and practice the highlighted characters."
    };
    if (totalPct >= 50) return {
      zh: "åˆ¥æ€¥ï¼Œå…ˆåˆ†æ®µæœ—è®€ä¸¦é‡è¤‡ç·´ç¿’ï¼Œå†å®Œæ•´æœ—è®€ä¸€æ¬¡ã€‚",
      en: "Don't rushâ€”read in chunks, repeat, then attempt a full read."
    };
    return {
      zh: "åŠ æ²¹ï¼å…ˆè½ç¤ºç¯„å…©éï¼Œé€å­—è·Ÿè®€ï¼Œç¢ºèªæ¯å€‹å­—éƒ½æœ‰ç™¼åˆ°ä½ã€‚",
      en: "Keep at it! Listen twice, echo word-by-word, and ensure each syllable lands."
    };
  }

  function renderDiffHTML(targetRaw, heardRaw){
    const {distance, ops, baseLen} = diffAlign(targetRaw, heardRaw);
    const partsA = []; // ä¾‹å¥
    const partsB = []; // è¾¨è­˜
    for(const op of ops){
      if(op.type==='EQ'){
        partsA.push(`<span class="ok">${op.a}</span>`);
        partsB.push(`<span class="ok">${op.b}</span>`);
      }else if(op.type==='SUB'){
        partsA.push(`<span class="highlight" title="æ‡‰ç‚ºï¼š${op.a}">${op.a}</span>`);
        partsB.push(`<span class="highlight" title="è¾¨ç‚ºï¼š${op.b}">${op.b}</span>`);
      }else if(op.type==='DEL'){ // ä¾‹å¥æœ‰ã€è¾¨è­˜æ¼
        partsA.push(`<span class="highlight" title="æœªå”¸å‡ºï¼š${op.a}">${op.a}</span>`);
        partsB.push(`<span class="highlight" title="æœªå”¸å‡º">âˆ…</span>`);
      }else if(op.type==='INS'){ // ä¾‹å¥ç„¡ã€è¾¨è­˜å¤š
        partsA.push(`<span class="highlight" title="å¤šå”¸">âˆ…</span>`);
        partsB.push(`<span class="highlight" title="å¤šå”¸ï¼š${op.b}">${op.b}</span>`);
      }
    }
    const acc = Math.max(0, 1 - distance / baseLen);
    const pct = Math.round(acc*100);
    const html =
      `<div class="row"><span class="label">ä¾‹å¥ï¼š</span>${partsA.join('')}</div>`+
      `<div class="row"><span class="label">è¾¨è­˜ï¼š</span>${partsB.join('')}</div>`;
    return { html, pct };
  }

  // ====== ç·´ç¿’æ¨¡å¼ ======
  let currentSentence = "";
  const records = []; // ç·´ç¿’ç´€éŒ„ï¼ˆTXT åŒ¯å‡ºç”¨ï¼‰

  function newSentence() {
    const topic = document.getElementById("topic").value;
    const list = sentences[topic];
    currentSentence = list[Math.floor(Math.random() * list.length)];
    document.getElementById("sentence").innerText = currentSentence;
    document.getElementById("result").innerText = "å°šç„¡çµæœ";
    document.getElementById("diff").innerText = "å°šç„¡çµæœ";
    document.getElementById("accuracy").innerText = "â€”";
    document.getElementById("feedback").innerText = "";
  }

  function playSentence() {
    if (!currentSentence) { alert("è«‹å…ˆç”Ÿæˆå¥å­ï¼"); return; }
    const u = new SpeechSynthesisUtterance(currentSentence);
    u.lang = "zh-TW";
    speechSynthesis.cancel(); speechSynthesis.speak(u);
  }

  function startRecognition() {
    if (!('webkitSpeechRecognition' in window)) {
      alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼Œè«‹ä½¿ç”¨ Chromeã€‚");
      return;
    }
    if (!currentSentence) { alert("è«‹å…ˆæŒ‰ã€Œæ›ä¸€å¥ã€ç”Ÿæˆå¥å­ï¼"); return; }
    const recognition = new webkitSpeechRecognition();
    recognition.lang = "zh-TW";
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.start();

    recognition.onresult = function(event) {
      const resultText = event.results[0][0].transcript;
      document.getElementById("result").innerText = resultText;

      const { html, pct } = renderDiffHTML(currentSentence, resultText);
      document.getElementById("diff").innerHTML = html;
      document.getElementById("accuracy").innerText = pct + "%";
      document.getElementById("feedback").innerText = feedbackByScore(pct);

      // ç·´ç¿’ç´€éŒ„
      const topicSel = document.getElementById("topic");
      const topicName = topicSel.options[topicSel.selectedIndex].text;
      records.push({
        time: nowString(),
        topic: topicName,
        sentence: currentSentence,
        recognized: resultText,
        accuracy: pct,
        feedback: feedbackByScore(pct)
      });
    };
  }

  function downloadTxt(){
    if (records.length === 0) {
      alert("å°šç„¡æˆç¸¾å¯ä¸‹è¼‰ã€‚è«‹å…ˆå®Œæˆä¸€æ¬¡éŒ„éŸ³ç·´ç¿’ã€‚");
      return;
    }
    const lines = [];
    lines.push("ã€ä¸­æ–‡å£èªå³æ™‚æ¯”å°ï½œç·´ç¿’æˆç¸¾å–®ã€‘");
    lines.push(`åŒ¯å‡ºæ™‚é–“ï¼š${nowString()}`);
    lines.push("");
    lines.push("æ™‚é–“\tä¸»é¡Œ\tä¾‹å¥\tè¾¨è­˜çµæœ\tæ­£ç¢ºç‡(%)\tå»ºè­°èˆ‡å›é¥‹");
    for (const r of records) {
      const clean = s => (s||"").replace(/\r?\n/g," ").trim();
      lines.push(
        `${r.time}\t${clean(r.topic)}\t${clean(r.sentence)}\t${clean(r.recognized)}\t${r.accuracy}\t${clean(r.feedback)}`
      );
    }
    const content = lines.join("\n");
    const blob = new Blob(["\uFEFF" + content], {type: "text/plain;charset=utf-8;"}); // BOM for Notepad
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "practice_results.txt"; a.click();
    URL.revokeObjectURL(url);
  }

  // ====== æ¸¬é©—æ¨¡å¼ ======
  let quizQueue = [];   // 3 é¡Œçš„å¥å­
  let quizIndex = -1;   // ç›®å‰é¡Œè™Ÿï¼ˆ0~2ï¼‰
  let quizHeard = "";   // æœ¬é¡Œè¾¨è­˜
  let quizTopicName = "";
  const quizRecords = []; // {idx, sentence, recognized, pct, diffHTML}

  function setQuizState(text){ document.getElementById("quizState").innerText = text; }

  function startQuiz(){
    const sel = document.getElementById("quizTopic");
    const key = sel.value;
    quizTopicName = sel.options[sel.selectedIndex].text;

    // å¾ä¸»é¡Œéš¨æ©ŸæŠ½ 3 å¥ï¼ˆä¸é‡è¦†ï¼‰
    const pool = [...sentences[key]];
    quizQueue = [];
    for(let i=0;i<3;i++){
      const idx = Math.floor(Math.random()*pool.length);
      quizQueue.push(pool.splice(idx,1)[0]);
    }
    quizRecords.length = 0;
    quizIndex = -1;
    quizHeard = "";
    document.getElementById("quizSummary").style.display = "none";
    document.getElementById("quizFeedback").innerText = "â€”";
    setQuizState("å·²æŠ½é¡Œï¼ŒæŒ‰ã€Œæäº¤æœ¬é¡Œã€å‰è«‹å…ˆéŒ„éŸ³ã€‚");
    nextQuiz();
  }

  function nextQuiz(){
    quizIndex++;
    if(quizIndex >= quizQueue.length){
      finishQuiz();
      return;
    }
    const s = quizQueue[quizIndex];
    document.getElementById("quizSentence").innerText = `ç¬¬ ${quizIndex+1} é¡Œï¼š${s}`;
    document.getElementById("quizHeard").innerText = "â€”";
    document.getElementById("quizDiff").innerText = "ï¼ˆé«˜å…‰å·®ç•°æœƒé¡¯ç¤ºåœ¨é€™è£¡ï¼‰";
    quizHeard = "";
    setQuizState(`ä½œç­”ä¸­ï¼ˆç¬¬ ${quizIndex+1}/3 é¡Œï¼‰`);
  }

  function quizPlay(){
    const txt = quizQueue[quizIndex];
    if(!txt){ alert("è«‹å…ˆé–‹å§‹æ¸¬é©—ã€‚"); return; }
    const u = new SpeechSynthesisUtterance(txt);
    u.lang = "zh-TW";
    speechSynthesis.cancel(); speechSynthesis.speak(u);
  }

  function quizRecord(){
    if (!('webkitSpeechRecognition' in window)) {
      alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼Œè«‹ä½¿ç”¨ Chromeã€‚");
      return;
    }
    const txt = quizQueue[quizIndex];
    if(!txt){ alert("è«‹å…ˆé–‹å§‹æ¸¬é©—ã€‚"); return; }

    const recognition = new webkitSpeechRecognition();
    recognition.lang = "zh-TW";
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.start();

    recognition.onresult = function(event) {
      quizHeard = event.results[0][0].transcript || "";
      document.getElementById("quizHeard").innerText = quizHeard || "ï¼ˆæœªå–å¾—è¾¨è­˜ï¼‰";
      const { html } = renderDiffHTML(txt, quizHeard);
      document.getElementById("quizDiff").innerHTML = html;
    };
  }

  function quizSubmit(){
    const txt = quizQueue[quizIndex];
    if(!txt){ alert("è«‹å…ˆé–‹å§‹æ¸¬é©—ã€‚"); return; }
    if(!quizHeard){ alert("è«‹å…ˆéŒ„éŸ³å†æäº¤æœ¬é¡Œã€‚"); return; }

    const { html, pct } = renderDiffHTML(txt, quizHeard);
    quizRecords.push({
      idx: quizIndex+1,
      sentence: txt,
      recognized: quizHeard,
      pct,
      diffHTML: html
    });

    // ä¸‹ä¸€é¡Œæˆ–çµæŸ
    nextQuiz();
  }

  function finishQuiz(){
    setQuizState("æ¸¬é©—å®Œæˆ");
    // çµ±è¨ˆç¸½åˆ†
    const total = Math.round(quizRecords.reduce((s,r)=>s+r.pct,0) / quizRecords.length);
    document.getElementById("quizTotal").innerText = total + "%";

    // ç¸½è©•ï¼ˆé›™èªï¼‰
    const fb = quizOverallFeedback(total);
    document.getElementById("quizFeedback").innerText = `${fb.zh} / ${fb.en}`;

    // å¡«è¡¨
    const tbody = document.querySelector("#quizTable tbody");
    tbody.innerHTML = "";
    for(const r of quizRecords){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.idx}</td>
        <td>${r.diffHTML}</td>
        <td>${r.pct}%</td>
      `;
      tbody.appendChild(tr);
    }
    document.getElementById("quizSummary").style.display = "block";
  }

  function downloadQuizTXT(){
    if(quizRecords.length !== 3){
      alert("è«‹å…ˆå®Œæˆä¸€æ¬¡ 3 é¡Œçš„æ¸¬é©—ã€‚");
      return;
    }
    const lines = [];
    lines.push("ã€ä¸­æ–‡å£èªå³æ™‚æ¯”å°ï½œæœ¬æ¬¡æ¸¬é©—ã€‘");
    lines.push(`åŒ¯å‡ºæ™‚é–“ï¼š${nowString()}`);
    lines.push(`ä¸»é¡Œï¼š${quizTopicName}`);
    const total = Math.round(quizRecords.reduce((s,r)=>s+r.pct,0) / quizRecords.length);
    const fb = quizOverallFeedback(total);
    lines.push(`ç¸½æ­£ç¢ºç‡ï¼š${total}%`);
    lines.push(`ç¸½è©•ï¼ˆä¸­æ–‡ï¼‰ï¼š${fb.zh}`);
    lines.push(`Overall Feedback (EN): ${fb.en}`);
    lines.push("");
    lines.push("é¡Œæ¬¡\tä¾‹å¥\tè¾¨è­˜çµæœ\tæ­£ç¢ºç‡(%)");
    for(const r of quizRecords){
      const clean = s => (s||"").replace(/\r?\n/g," ").trim();
      lines.push(`${r.idx}\t${clean(r.sentence)}\t${clean(r.recognized)}\t${r.pct}`);
    }
    const blob = new Blob(["\uFEFF" + lines.join("\n")], {type:"text/plain;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "quiz_results.txt"; a.click();
    URL.revokeObjectURL(url);
  }

  function downloadQuizCSV(){
    if(quizRecords.length !== 3){
      alert("è«‹å…ˆå®Œæˆä¸€æ¬¡ 3 é¡Œçš„æ¸¬é©—ã€‚");
      return;
    }
    const total = Math.round(quizRecords.reduce((s,r)=>s+r.pct,0) / quizRecords.length);
    const fb = quizOverallFeedback(total);

    const rows = [];
    rows.push(["é¡Œæ¬¡","ä¾‹å¥","è¾¨è­˜çµæœ","æ­£ç¢ºç‡(%)"].join(","));
    for(const r of quizRecords){
      const esc = s => `"${(s||"").replace(/"/g,'""')}"`;
      rows.push([r.idx, esc(r.sentence), esc(r.recognized), r.pct].join(","));
    }
    // å¦åŠ ä¸€åˆ—æ”¾ç¸½è©•ï¼ˆä¸­/ENï¼‰
    const esc = s => `"${(s||"").replace(/"/g,'""')}"`;
    rows.push(["", "", "", ""].join(",")); // ç©ºè¡Œ
    rows.push(["ç¸½æ­£ç¢ºç‡(%)", total, "", ""].join(","));
    rows.push(["ç¸½è©•(ä¸­æ–‡/EN)", esc(fb.zh + " / " + fb.en), "", ""].join(","));

    const csv = "\uFEFF" + rows.join("\n"); // åŠ  BOM
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "quiz_results.csv"; a.click();
    URL.revokeObjectURL(url);
  }
</script>
</body>
</html>
