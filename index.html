<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ä¸­æ–‡å£èªå³æ™‚æ¯”å°å°ç¨‹å¼ï¼ˆèª²æ¬¡ç‰ˆï¼‰</title>
  <style>
    body { font-family: "Microsoft JhengHei", Arial, sans-serif; background:#fafafa; margin:0; padding:20px; }
    .container { max-width: 980px; margin:0 auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 0 10px rgba(0,0,0,.08); }
    h1 { text-align:center; margin-top:0; color:#333; }
    h2 { margin-top:28px; }
    select, button, input[type="file"] { padding:8px 12px; margin:5px; font-size:16px; }
    .sentence { font-size:20px; text-align:center; margin:20px 0; padding:10px; background:#f1f1f1; border-radius:8px; }
    #result, #diff, #quizDiff, .box { padding:10px; margin-top:10px; background:#f9f9f9; border:1px solid #ddd; min-height:30px; border-radius:8px; }
    .row { margin:6px 0; }
    .label { color:#666; font-size:14px; margin-right:6px; }
    .highlight { background:yellow; font-weight:bold; }
    .ok { background:rgba(22,163,74,.12); }
    .note { color:#6b7280; font-size:12px; }
    .scoreRow { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    #feedback { color:#374151; font-size:15px; }
    .muted { color:#6b7280; }
    .flex { display:flex; gap:20px; flex-wrap:wrap; }
    .col { flex:1 1 380px; }
    table { width:100%; border-collapse:collapse; }
    th, td { border-bottom:1px solid #eaeaea; padding:8px; text-align:left; vertical-align:top; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .em { font-weight:600; }
    .pill { display:inline-block; background:#eef2ff; padding:2px 8px; border-radius:999px; font-size:12px; margin:2px 6px 2px 0; }
    .list { display:flex; flex-wrap:wrap; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ä¸­æ–‡å£èªå³æ™‚æ¯”å°ï¼ˆèª²æ¬¡ç‰ˆï¼‰</h1>

    <!-- å¥åº«ç®¡ç†ï¼ˆèª²æ¬¡ï¼‰ -->
    <h2>å¥åº«ç®¡ç†</h2>
    <div class="box">
      <div class="actions">
        <input type="file" id="importFile" accept=".csv,.xlsx,.xls" />
        <label><input type="radio" name="importMode" value="merge" checked> åˆä½µ</label>
        <label><input type="radio" name="importMode" value="replace"> å–ä»£ï¼ˆåªå–ä»£æœ‰åŒ¯å…¥ä¹‹èª²æ¬¡ï¼‰</label>
        <button onclick="importSentences()">åŒ¯å…¥å¥åº«ï¼ˆExcel/CSVï¼‰</button>
        <button onclick="downloadTemplate()">ä¸‹è¼‰åŒ¯å…¥ç¯„æœ¬ï¼ˆCSVï¼‰</button>
      </div>
      <div class="note">æª”æ¡ˆæ¬„ä½ï¼š<b>Lesson</b>, <b>Sentence</b>ã€‚èª²æ¬¡åç¨±å¯è‡ªè¨‚ï¼ˆå¦‚ï¼šç¬¬ä¸€èª²ã€ç¬¬äºŒèª²â€¦ï¼‰ã€‚</div>
      <div class="note">ç›®å‰èª²æ¬¡èˆ‡å¥æ•¸ï¼š</div>
      <div id="lessonStats" class="list"></div>
    </div>

    <div class="flex">
      <!-- ç·´ç¿’ -->
      <div class="col">
        <h2>ç·´ç¿’</h2>
        <div class="actions">
          <label for="lesson">é¸æ“‡èª²æ¬¡ï¼š</label>
          <select id="lesson"></select>
          <button onclick="newSentence()">æ›ä¸€å¥</button>
        </div>

        <div class="sentence" id="sentence">è«‹æŒ‰ã€Œæ›ä¸€å¥ã€ç”Ÿæˆå¥å­</div>

        <div class="actions">
          <button onclick="playSentence()">ğŸ”Š ç¤ºç¯„ç™¼éŸ³</button>
          <button onclick="startRecognition()">ğŸ™ï¸ é–‹å§‹éŒ„éŸ³</button>
        </div>

        <h3>è¾¨è­˜çµæœï¼š</h3>
        <div id="result">å°šç„¡çµæœ</div>

        <h3>å·®ç•°é«˜å…‰ï¼š</h3>
        <div id="diff">å°šç„¡çµæœ</div>
        <div class="note">èªªæ˜ï¼šç¶ åº•ç‚ºä¸€è‡´ï¼Œé«˜å…‰ç‚ºä¸åŒï¼›ä¾‹å¥ç¼ºæ¼ä»¥ <b>âˆ…</b> é¡¯ç¤ºï¼Œè¾¨è­˜å¤šå”¸æœƒåœ¨ã€Œè¾¨è­˜ã€è¡Œä»¥é«˜å…‰é¡¯ç¤ºã€‚</div>

        <h3>æ­£ç¢ºç‡ï¼š</h3>
        <div class="scoreRow">
          <div id="accuracy">â€”</div>
          <div id="feedback"></div>
          <button id="btnDownload" onclick="downloadTxt()">â¬‡ï¸ ä¸‹è¼‰æˆç¸¾ï¼ˆTXTï¼‰</button>
        </div>
      </div>

      <!-- æ¸¬é©— -->
      <div class="col">
        <h2>æ¸¬é©—</h2>
        <div class="box">
          <div class="actions">
            <label for="quizLesson">èª²æ¬¡ï¼š</label>
            <select id="quizLesson"></select>
            <button onclick="startQuiz()">é–‹å§‹æ¸¬é©—ï¼ˆ3é¡Œï¼‰</button>
          </div>

          <div class="muted">ç‹€æ…‹ï¼š<span id="quizState">æœªé–‹å§‹</span></div>
          <div class="sentence" id="quizSentence">ï¼ˆé–‹å§‹å¾Œé¡¯ç¤ºæœ¬é¡Œå¥å­ï¼‰</div>

          <div class="actions">
            <button onclick="quizPlay()">ğŸ”Š ç¤ºç¯„ç™¼éŸ³</button>
            <button onclick="quizRecord()">ğŸ™ï¸ é–‹å§‹éŒ„éŸ³</button>
            <button onclick="quizSubmit()">æäº¤æœ¬é¡Œ</button>
          </div>

          <div class="row"><span class="label">æœ¬é¡Œè¾¨è­˜ï¼š</span><span id="quizHeard">â€”</span></div>
          <div id="quizDiff">ï¼ˆé«˜å…‰å·®ç•°æœƒé¡¯ç¤ºåœ¨é€™è£¡ï¼‰</div>
        </div>

        <div id="quizSummary" class="box" style="display:none;">
          <h3>æœ¬æ¬¡æ¸¬é©—çµæœ</h3>
          <div class="row">ç¸½æ­£ç¢ºç‡ï¼š<b id="quizTotal">â€”</b></div>
          <div class="row">ç¸½è©•ï¼ˆä¸­ / ENï¼‰ï¼š<span id="quizFeedback" class="em">â€”</span></div>
          <div class="actions">
            <button onclick="downloadQuizTXT()">â¬‡ï¸ ä¸‹è¼‰æœ¬æ¬¡ï¼ˆTXTï¼‰</button>
            <button onclick="downloadQuizCSV()">â¬‡ï¸ ä¸‹è¼‰æœ¬æ¬¡ï¼ˆCSVï¼‰</button>
          </div>

          <h4>è¾¨è­˜æ¯”å°è¡¨ï¼ˆ3é¡Œï¼‰</h4>
          <table id="quizTable">
            <thead>
              <tr>
                <th style="width:40px;">é¡Œ</th>
                <th>ä¾‹å¥ / è¾¨è­˜ï¼ˆé›™è¡Œé«˜å…‰ï¼‰</th>
                <th style="width:80px;">æ­£ç¢ºç‡</th>
              </tr>
            </thead>
            <tbody><!-- JS å‹•æ…‹å¡«å…¥ --></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<!-- è§£æ Excel ç”¨ï¼ˆSheetJSï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
  // ====== åˆå§‹èª²æ¬¡å¥åº«ï¼ˆå¯è¢«åŒ¯å…¥è¦†è“‹/åˆä½µï¼‰======
  let lessons = {
    "ç¬¬ä¸€èª²": [
      "è«‹å•æ•™å‹™è™•åœ¨å¹¾æ¨“ï¼Œæˆ‘è¦è¾¦ç†åŠ é€€é¸",
      "åœ–æ›¸é¤¨ä»Šå¤©é–‹åˆ°å¹¾é»ï¼Œæˆ‘æƒ³å€Ÿåƒè€ƒæ›¸",
      "ä¸‹é€±çš„å°çµ„å ±å‘Šéœ€è¦ä¸Šè‡ºç°¡å ±ååˆ†é˜",
      "é«”è‚²èª²è¦ç©¿é‹å‹•æœå’Œç™½è‰²çƒé‹",
      "ç³»è¾¦å…¬å‘Šèªªæ˜æœƒæ”¹åˆ°ä¸‹åˆä¸‰é»"
    ],
    "ç¬¬äºŒèª²": [
      "åˆ°è‡ºåŒ—è»Šç«™è¦æ›å“ªä¸€æ¢æ·é‹ç·š",
      "å…¬è»Šåˆ°ç«™è«‹å¾å¾Œé–€ä¸‹è»Šä¸è¦æ“ ",
      "æ©Ÿå ´å¿«ç·šæœ«ç­è»Šæ˜¯æ™šä¸Šåä¸€é»",
      "é€™ä¸€ç«™ä¹‹å¾Œè«‹è¨˜å¾—æŒ‰ä¸‹ä¸‹è»Šéˆ´",
      "é«˜éµè‡ªç”±åº§éœ€è¦å…ˆæ’éšŠå€™è»Š"
    ],
    "ç¬¬ä¸‰èª²": [
      "é€™ä»¶å¤–å¥—æœ‰æ²’æœ‰å°ä¸€è™Ÿçš„å°ºå¯¸",
      "ç‰¹åƒ¹å•†å“å”®å‡ºæ•ä¸é€€æ›è«‹ç•™æ„",
      "çµå¸³å¯ä»¥ä½¿ç”¨è¡Œå‹•æ”¯ä»˜å’Œç™¼ç¥¨è¼‰å…·",
      "æœƒå“¡ä»Šå¤©æ»¿åƒé€ç™¾å¦å¤–æœ‰é»æ•¸",
      "è©¦ç©¿é–“åœ¨å³é‚Šèµ°åˆ°åº•å·¦è½‰"
    ],
    "ç¬¬å››èª²": [
      "è«‹ä¸è¦é¦™èœè¬è¬å¦å¤–åŠ ä¸€é»è¾£",
      "å…§ç”¨é‚„æ˜¯å¤–å¸¶éœ€è¦ç™¼ç¥¨å—",
      "é€™é“ç‰›è‚‰éºµå¯ä»¥èª¿æ•´éºµæ¢è»Ÿç¡¬",
      "ä»Šå¤©çš„æ¹¯æ˜¯è˜¿è””æ’éª¨é‚„æœ‰æµ·å¸¶",
      "é£²æ–™åŠç³–å»å†°å°±å¯ä»¥äº†"
    ],
    "ç¬¬äº”èª²": [
      "ç§Ÿå±‹åˆç´„æœ€çŸ­éœ€ä¸€å¹´å¯å¦æ¥å—",
      "æ°´é›»å¦è¨ˆæ¯æœˆç®¡ç†è²»äº”ç™¾å…ƒ",
      "æŠ¼é‡‘å…©å€‹æœˆé€€ç§Ÿæ™‚æœƒé»äº¤",
      "è«‹å‹¿é£¼é¤Šå¯µç‰©ä¸¦ä¿æŒå…¬å…±å®‰éœ",
      "åƒåœ¾éœ€ä¾è¦å®šåˆ†é¡æŠ•æ”¾"
    ]
  };

  // ====== å…±ç”¨ï¼šæ™‚é–“ã€æ­£è¦åŒ–ã€æ¯”å° ======
  function nowString(){ const t=new Date(),p=n=>String(n).padStart(2,'0'); return `${t.getFullYear()}-${p(t.getMonth()+1)}-${p(t.getDate())} ${p(t.getHours())}:${p(t.getMinutes())}:${p(t.getSeconds())}`; }
  function normalize(str){ if(!str) return ""; return str.replace(/[\s\p{P}\p{S}]/gu,'').replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g,s=>String.fromCharCode(s.charCodeAt(0)-0xFEE0)); }
  function diffAlign(aRaw,bRaw){
    const a=normalize(aRaw), b=normalize(bRaw), n=a.length, m=b.length;
    const dp=Array.from({length:n+1},()=>Array(m+1).fill(0));
    const bt=Array.from({length:n+1},()=>Array(m+1).fill(null));
    for(let i=0;i<=n;i++){ dp[i][0]=i; bt[i][0]='U'; }
    for(let j=0;j<=m;j++){ dp[0][j]=j; bt[0][j]='L'; }
    for(let i=1;i<=n;i++){ for(let j=1;j<=m;j++){
      const cost=a[i-1]===b[j-1]?0:1;
      const d=dp[i-1][j-1]+cost, u=dp[i-1][j]+1, l=dp[i][j-1]+1;
      const best=Math.min(d,u,l); dp[i][j]=best; bt[i][j]=best===d?'D':best===u?'U':'L';
    }}
    let i=n,j=m,ops=[]; while(i>0||j>0){ const mv=bt[i][j];
      if(mv==='D'){ ops.push({type:a[i-1]===b[j-1]?'EQ':'SUB', a:a[i-1], b:b[j-1]}); i--; j--; }
      else if(mv==='U'){ ops.push({type:'DEL', a:a[i-1], b:''}); i--; }
      else { ops.push({type:'INS', a:'', b:b[j-1]}); j--; }
    }
    ops.reverse(); return {distance:dp[n][m], ops, baseLen:Math.max(1,a.length)};
  }
  function renderDiffHTML(targetRaw, heardRaw){
    const {distance, ops, baseLen}=diffAlign(targetRaw, heardRaw);
    const A=[], B=[];
    for(const op of ops){
      if(op.type==='EQ'){ A.push(`<span class="ok">${op.a}</span>`); B.push(`<span class="ok">${op.b}</span>`); }
      else if(op.type==='SUB'){ A.push(`<span class="highlight" title="æ‡‰ç‚ºï¼š${op.a}">${op.a}</span>`); B.push(`<span class="highlight" title="è¾¨ç‚ºï¼š${op.b}">${op.b}</span>`); }
      else if(op.type==='DEL'){ A.push(`<span class="highlight" title="æœªå”¸å‡ºï¼š${op.a}">${op.a}</span>`); B.push(`<span class="highlight" title="æœªå”¸å‡º">âˆ…</span>`); }
      else if(op.type==='INS'){ A.push(`<span class="highlight" title="å¤šå”¸">âˆ…</span>`); B.push(`<span class="highlight" title="å¤šå”¸ï¼š${op.b}">${op.b}</span>`); }
    }
    const pct=Math.round(Math.max(0,1-distance/baseLen)*100);
    const html=`<div class="row"><span class="label">ä¾‹å¥ï¼š</span>${A.join('')}</div><div class="row"><span class="label">è¾¨è­˜ï¼š</span>${B.join('')}</div>`;
    return { html, pct };
  }
  function feedbackByScore(pct){
    if (pct>=95) return "å¤ªæ£’äº†ï¼å¹¾ä¹å®Œå…¨æ­£ç¢ºï¼Œç¶­æŒæ¸…æ™°çš„å’¬å­—èˆ‡ç©©å®šçš„èªé€Ÿã€‚";
    if (pct>=85) return "å¾ˆä¸éŒ¯ï¼å†æ³¨æ„å€‹åˆ¥å­—çš„æ”¶å°¾èˆ‡é€£éŸ³ï¼Œæ”¾æ…¢ä¸€é»æ›´ç©©ã€‚";
    if (pct>=70) return "æœ‰é€²æ­¥ï¼å»ºè­°å…ˆè·Ÿè‘—ç¤ºç¯„æ…¢é€Ÿæœ—è®€ï¼Œé‡å°é«˜å…‰å­—å¤šç·´å¹¾æ¬¡ã€‚";
    if (pct>=50) return "åˆ¥æ€¥ï¼Œå…ˆåˆ†æ®µæœ—è®€ä¸¦é‡è¤‡ç·´ç¿’ï¼Œå†å®Œæ•´æœ—è®€ä¸€æ¬¡ã€‚";
    return "åŠ æ²¹ï¼å…ˆè½ç¤ºç¯„å…©éï¼Œé€å­—è·Ÿè®€ï¼Œç¢ºèªæ¯å€‹å­—éƒ½æœ‰ç™¼åˆ°ä½ã€‚";
  }
  function quizOverallFeedback(totalPct){
    if (totalPct>=95) return { zh:"å¤ªæ£’äº†ï¼å¹¾ä¹å®Œå…¨æ­£ç¢ºï¼Œç¶­æŒæ¸…æ™°çš„å’¬å­—èˆ‡ç©©å®šçš„èªé€Ÿã€‚", en:"Excellent! Nearly perfect accuracyâ€”keep your articulation clear and pace steady." };
    if (totalPct>=85) return { zh:"å¾ˆä¸éŒ¯ï¼å†æ³¨æ„å€‹åˆ¥å­—çš„æ”¶å°¾èˆ‡é€£éŸ³ï¼Œæ”¾æ…¢ä¸€é»æ›´ç©©ã€‚", en:"Great work! Watch final consonants and liaison; a slightly slower pace adds stability." };
    if (totalPct>=70) return { zh:"æœ‰é€²æ­¥ï¼å»ºè­°è·Ÿè‘—ç¤ºç¯„æ…¢é€Ÿæœ—è®€ï¼Œé‡å°é«˜å…‰å­—å¤šç·´å¹¾æ¬¡ã€‚", en:"Good progress! Shadow the demo slowly and practice the highlighted characters." };
    if (totalPct>=50) return { zh:"åˆ¥æ€¥ï¼Œå…ˆåˆ†æ®µæœ—è®€ä¸¦é‡è¤‡ç·´ç¿’ï¼Œå†å®Œæ•´æœ—è®€ä¸€æ¬¡ã€‚", en:"Don't rushâ€”read in chunks, repeat, then attempt a full read." };
    return { zh:"åŠ æ²¹ï¼å…ˆè½ç¤ºç¯„å…©éï¼Œé€å­—è·Ÿè®€ï¼Œç¢ºèªæ¯å€‹å­—éƒ½æœ‰ç™¼åˆ°ä½ã€‚", en:"Keep at it! Listen twice, echo word-by-word, and ensure each syllable lands." };
  }

  // ====== UIï¼šèª²æ¬¡é¸å–®èˆ‡çµ±è¨ˆ ======
  function refreshLessonOptions(){
    const sel1=document.getElementById("lesson");
    const sel2=document.getElementById("quizLesson");
    const keys=Object.keys(lessons);
    const fill=(sel)=>{ sel.innerHTML=""; keys.forEach(k=>{ const o=document.createElement("option"); o.value=k; o.textContent=k; sel.appendChild(o); }); };
    fill(sel1); fill(sel2);
  }
  function renderLessonStats(){
    const box=document.getElementById("lessonStats");
    box.innerHTML="";
    Object.entries(lessons).forEach(([k,arr])=>{
      const span=document.createElement("span");
      span.className="pill";
      span.textContent=`${k}ï¼š${(arr||[]).length} å¥`;
      box.appendChild(span);
    });
  }
  refreshLessonOptions(); renderLessonStats();

  // ====== ç·´ç¿’ ======
  let currentSentence="";
  const practiceRecords=[];
  function newSentence(){
    const key=document.getElementById("lesson").value;
    const list=lessons[key]||[];
    if(list.length===0){ alert("æ­¤èª²æ¬¡ç›®å‰æ²’æœ‰å¥å­ï¼Œè«‹å…ˆåŒ¯å…¥ã€‚"); return; }
    currentSentence=list[Math.floor(Math.random()*list.length)];
    document.getElementById("sentence").innerText=currentSentence;
    document.getElementById("result").innerText="å°šç„¡çµæœ";
    document.getElementById("diff").innerText="å°šç„¡çµæœ";
    document.getElementById("accuracy").innerText="â€”";
    document.getElementById("feedback").innerText="";
  }
  function playSentence(){
    if(!currentSentence){ alert("è«‹å…ˆç”Ÿæˆå¥å­ï¼"); return; }
    const u=new SpeechSynthesisUtterance(currentSentence); u.lang="zh-TW";
    speechSynthesis.cancel(); speechSynthesis.speak(u);
  }
  function startRecognition(){
    if(!('webkitSpeechRecognition'in window)){ alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼Œè«‹ä½¿ç”¨ Chromeã€‚"); return; }
    if(!currentSentence){ alert("è«‹å…ˆæŒ‰ã€Œæ›ä¸€å¥ã€ç”Ÿæˆå¥å­ï¼"); return; }
    const r=new webkitSpeechRecognition(); r.lang="zh-TW"; r.continuous=false; r.interimResults=false; r.start();
    r.onresult=function(e){
      const heard=e.results[0][0].transcript;
      document.getElementById("result").innerText=heard;
      const {html,pct}=renderDiffHTML(currentSentence, heard);
      document.getElementById("diff").innerHTML=html;
      document.getElementById("accuracy").innerText=pct+"%";
      document.getElementById("feedback").innerText=feedbackByScore(pct);
      const key=document.getElementById("lesson").value;
      practiceRecords.push({ time:nowString(), lesson:key, sentence:currentSentence, recognized:heard, accuracy:pct, feedback:feedbackByScore(pct) });
    };
  }
  function downloadTxt(){
    if(practiceRecords.length===0){ alert("å°šç„¡æˆç¸¾å¯ä¸‹è¼‰ã€‚è«‹å…ˆå®Œæˆä¸€æ¬¡éŒ„éŸ³ç·´ç¿’ã€‚"); return; }
    const lines=["ã€ä¸­æ–‡å£èªå³æ™‚æ¯”å°ï½œç·´ç¿’æˆç¸¾å–®ã€‘",`åŒ¯å‡ºæ™‚é–“ï¼š${nowString()}`,"","æ™‚é–“\tèª²æ¬¡\tä¾‹å¥\tè¾¨è­˜çµæœ\tæ­£ç¢ºç‡(%)\tå»ºè­°èˆ‡å›é¥‹"];
    const clean=s=>(s||"").replace(/\r?\n/g," ").trim();
    practiceRecords.forEach(r=>lines.push(`${r.time}\t${clean(r.lesson)}\t${clean(r.sentence)}\t${clean(r.recognized)}\t${r.accuracy}\t${clean(r.feedback)}`));
    const blob=new Blob(["\uFEFF"+lines.join("\n")],{type:"text/plain;charset=utf-8;"}), url=URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download="practice_results.txt"; a.click(); URL.revokeObjectURL(url);
  }

  // ====== æ¸¬é©— ======
  let quizQueue=[], quizIndex=-1, quizHeard="", quizLessonName="";
  const quizRecords=[]; // {idx,sentence,recognized,pct,diffHTML}
  function setQuizState(t){ document.getElementById("quizState").innerText=t; }
  function startQuiz(){
    const key=document.getElementById("quizLesson").value; quizLessonName=key;
    const pool=[...(lessons[key]||[])]; if(pool.length<1){ alert("æ­¤èª²æ¬¡æ²’æœ‰å¥å­ï¼Œè«‹å…ˆåŒ¯å…¥ã€‚"); return; }
    quizQueue=[]; for(let i=0;i<3;i++){ if(pool.length===0) break; const idx=Math.floor(Math.random()*pool.length); quizQueue.push(pool.splice(idx,1)[0]); }
    if(quizQueue.length<3){ const base=lessons[key]||[]; while(quizQueue.length<3 && base.length>0){ quizQueue.push(base[Math.floor(Math.random()*base.length)]); } }
    quizRecords.length=0; quizIndex=-1; quizHeard=""; document.getElementById("quizSummary").style.display="none"; document.getElementById("quizFeedback").innerText="â€”";
    setQuizState("å·²æŠ½é¡Œï¼ŒæŒ‰ã€Œæäº¤æœ¬é¡Œã€å‰è«‹å…ˆéŒ„éŸ³ã€‚"); nextQuiz();
  }
  function nextQuiz(){
    quizIndex++; if(quizIndex>=quizQueue.length){ finishQuiz(); return; }
    const s=quizQueue[quizIndex]; document.getElementById("quizSentence").innerText=`ç¬¬ ${quizIndex+1} é¡Œï¼š${s}`;
    document.getElementById("quizHeard").innerText="â€”"; document.getElementById("quizDiff").innerText="ï¼ˆé«˜å…‰å·®ç•°æœƒé¡¯ç¤ºåœ¨é€™è£¡ï¼‰"; quizHeard="";
    setQuizState(`ä½œç­”ä¸­ï¼ˆç¬¬ ${quizIndex+1}/3 é¡Œï¼‰`);
  }
  function quizPlay(){ const txt=quizQueue[quizIndex]; if(!txt){ alert("è«‹å…ˆé–‹å§‹æ¸¬é©—ã€‚"); return; } const u=new SpeechSynthesisUtterance(txt); u.lang="zh-TW"; speechSynthesis.cancel(); speechSynthesis.speak(u); }
  function quizRecord(){
    if(!('webkitSpeechRecognition'in window)){ alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼Œè«‹ä½¿ç”¨ Chromeã€‚"); return; }
    const txt=quizQueue[quizIndex]; if(!txt){ alert("è«‹å…ˆé–‹å§‹æ¸¬é©—ã€‚"); return; }
    const r=new webkitSpeechRecognition(); r.lang="zh-TW"; r.continuous=false; r.interimResults=false; r.start();
    r.onresult=function(e){ quizHeard=e.results[0][0].transcript||""; document.getElementById("quizHeard").innerText=quizHeard||"ï¼ˆæœªå–å¾—è¾¨è­˜ï¼‰"; const {html}=renderDiffHTML(txt,quizHeard); document.getElementById("quizDiff").innerHTML=html; };
  }
  function quizSubmit(){
    const txt=quizQueue[quizIndex]; if(!txt){ alert("è«‹å…ˆé–‹å§‹æ¸¬é©—ã€‚"); return; }
    if(!quizHeard){ alert("è«‹å…ˆéŒ„éŸ³å†æäº¤æœ¬é¡Œã€‚"); return; }
    const {html,pct}=renderDiffHTML(txt, quizHeard);
    quizRecords.push({ idx:quizIndex+1, sentence:txt, recognized:quizHeard, pct, diffHTML:html });
    nextQuiz();
  }
  function finishQuiz(){
    setQuizState("æ¸¬é©—å®Œæˆ");
    const total=Math.round(quizRecords.reduce((s,r)=>s+r.pct,0)/quizRecords.length);
    document.getElementById("quizTotal").innerText=total+"%";
    const fb=quizOverallFeedback(total); document.getElementById("quizFeedback").innerText=`${fb.zh} / ${fb.en}`;
    const tbody=document.querySelector("#quizTable tbody"); tbody.innerHTML="";
    quizRecords.forEach(r=>{ const tr=document.createElement("tr"); tr.innerHTML=`<td>${r.idx}</td><td>${r.diffHTML}</td><td>${r.pct}%</td>`; tbody.appendChild(tr); });
    document.getElementById("quizSummary").style.display="block";
  }
  function downloadQuizTXT(){
    if(quizRecords.length!==3){ alert("è«‹å…ˆå®Œæˆä¸€æ¬¡ 3 é¡Œçš„æ¸¬é©—ã€‚"); return; }
    const total=Math.round(quizRecords.reduce((s,r)=>s+r.pct,0)/quizRecords.length), fb=quizOverallFeedback(total);
    const lines=["ã€ä¸­æ–‡å£èªå³æ™‚æ¯”å°ï½œæœ¬æ¬¡æ¸¬é©—ã€‘",`åŒ¯å‡ºæ™‚é–“ï¼š${nowString()}`,`èª²æ¬¡ï¼š${quizLessonName}`,`ç¸½æ­£ç¢ºç‡ï¼š${total}%`,`ç¸½è©•ï¼ˆä¸­æ–‡ï¼‰ï¼š${fb.zh}`,`Overall Feedback (EN): ${fb.en}`,"","é¡Œæ¬¡\tä¾‹å¥\tè¾¨è­˜çµæœ\tæ­£ç¢ºç‡(%)"];
    const clean=s=>(s||"").replace(/\r?\n/g," ").trim();
    quizRecords.forEach(r=>lines.push(`${r.idx}\t${clean(r.sentence)}\t${clean(r.recognized)}\t${r.pct}`));
    const blob=new Blob(["\uFEFF"+lines.join("\n")],{type:"text/plain;charset=utf-8;"}), url=URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download="quiz_results.txt"; a.click(); URL.revokeObjectURL(url);
  }
  function downloadQuizCSV(){
    if(quizRecords.length!==3){ alert("è«‹å…ˆå®Œæˆä¸€æ¬¡ 3 é¡Œçš„æ¸¬é©—ã€‚"); return; }
    const total=Math.round(quizRecords.reduce((s,r)=>s+r.pct,0)/quizRecords.length), fb=quizOverallFeedback(total);
    const rows=[["é¡Œæ¬¡","ä¾‹å¥","è¾¨è­˜çµæœ","æ­£ç¢ºç‡(%)"].join(",")];
    const esc=s=>`"${(s||"").replace(/"/g,'""')}"`;
    quizRecords.forEach(r=>rows.push([r.idx, esc(r.sentence), esc(r.recognized), r.pct].join(",")));
    rows.push(["", "", "", ""].join(",")); rows.push(["èª²æ¬¡", esc(quizLessonName), "", ""].join(",")); rows.push(["ç¸½æ­£ç¢ºç‡(%)", total, "", ""].join(",")); rows.push(["ç¸½è©•(ä¸­æ–‡/EN)", esc(fb.zh+" / "+fb.en), "", ""].join(","));
    const csv="\uFEFF"+rows.join("\n"); const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}), url=URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download="quiz_results.csv"; a.click(); URL.revokeObjectURL(url);
  }

  // ====== åŒ¯å…¥ï¼ˆExcel/CSVï¼‰ï¼šæ¬„ä½ Lesson, Sentence ======
  function importSentences(){
    const f=document.getElementById("importFile").files[0]; if(!f){ alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆï¼ˆCSV æˆ– Excelï¼‰ã€‚"); return; }
    const mode=document.querySelector('input[name="importMode"]:checked').value; const name=f.name.toLowerCase();
    if(name.endsWith(".csv")){
      const reader=new FileReader(); reader.onload=()=>applyImport(parseCSV(reader.result), mode); reader.readAsText(f,'utf-8');
    }else if(name.endsWith(".xlsx")||name.endsWith(".xls")){
      const reader=new FileReader(); reader.onload=()=>{ const wb=XLSX.read(reader.result,{type:"array"}); const ws=wb.Sheets[wb.SheetNames[0]]; const rows=XLSX.utils.sheet_to_json(ws,{header:1, raw:false}); applyImport(rows, mode); }; reader.readAsArrayBuffer(f);
    }else{ alert("ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ï¼Œè«‹ä½¿ç”¨ .csvã€.xlsx æˆ– .xls"); }
  }
  function parseCSV(text){ const lines=text.replace(/\r\n?/g,"\n").split("\n").filter(l=>l.trim().length>0); return lines.map(splitCSVLine); }
  function splitCSVLine(line){ const out=[]; let cur="", inQ=false; for(let i=0;i<line.length;i++){ const ch=line[i]; if(ch=='"'){ if(inQ && line[i+1]=='"'){ cur+='"'; i++; } else inQ=!inQ; } else if(ch===',' && !inQ){ out.push(cur); cur=""; } else { cur+=ch; } } out.push(cur); return out; }

  function applyImport(rows, mode){
    if(!rows||rows.length===0){ alert("æª”æ¡ˆå…§å®¹ç‚ºç©ºã€‚"); return; }
    // æ‰¾æ¨™é¡Œåˆ—ï¼ˆLesson / èª²æ¬¡ã€Sentence / å¥å­ / å…§å®¹ï¼‰
    const header = rows[0].map(h=>String(h||"").trim().toLowerCase());
    let idxLesson = header.findIndex(h=>["lesson","èª²æ¬¡"].includes(h));
    let idxSentence = header.findIndex(h=>["sentence","å¥å­","å…§å®¹","text"].includes(h));
    let startRow = 1;
    if(idxLesson===-1 || idxSentence===-1){ idxLesson=0; idxSentence=1; startRow=0; } // ç„¡è¡¨é ­

    const collected = {}; // { lessonName: [sentence...] }

    for(let r=startRow; r<rows.length; r++){
      const row=rows[r]; if(!row) continue;
      const lessonName=(row[idxLesson]??"").toString().trim();
      const sentence=(row[idxSentence]??"").toString().trim();
      if(!lessonName || !sentence) continue;
      if(!collected[lessonName]) collected[lessonName]=[];
      if(!collected[lessonName].includes(sentence)) collected[lessonName].push(sentence);
    }

    const touched=[];
    Object.keys(collected).forEach(lessonName=>{
      touched.push(lessonName);
      if(mode==="replace"){ lessons[lessonName]=collected[lessonName]; }
      else{ const set=new Set(lessons[lessonName]||[]); collected[lessonName].forEach(s=>set.add(s)); lessons[lessonName]=Array.from(set); }
    });

    refreshLessonOptions(); renderLessonStats();
    if(touched.length===0){ alert("æ‰¾ä¸åˆ°æœ‰æ•ˆè³‡æ–™ï¼Œè«‹ç¢ºèªæ¬„ä½èˆ‡å…§å®¹ã€‚"); return; }

    // è‡ªå‹•åˆ‡åˆ°ç¬¬ä¸€å€‹æ›´æ–°çš„èª²æ¬¡ä¸¦å‡ºé¡Œ
    const first=touched[0]; document.getElementById("lesson").value=first; document.getElementById("quizLesson").value=first; newSentence();
    alert(`åŒ¯å…¥å®Œæˆï¼æ›´æ–°èª²æ¬¡ï¼š${touched.join("ã€")}ã€‚`);
  }

  function downloadTemplate(){
    const lines=[
      "Lesson,Sentence",
      "ç¬¬ä¸€èª²,è«‹å•æ•™å‹™è™•åœ¨å¹¾æ¨“ï¼Œæˆ‘è¦è¾¦ç†åŠ é€€é¸",
      "ç¬¬äºŒèª²,åˆ°è‡ºåŒ—è»Šç«™è¦æ›å“ªä¸€æ¢æ·é‹ç·š",
      "ç¬¬ä¸‰èª²,é€™ä»¶å¤–å¥—æœ‰æ²’æœ‰å°ä¸€è™Ÿçš„å°ºå¯¸",
      "ç¬¬å››èª²,è«‹ä¸è¦é¦™èœè¬è¬å¦å¤–åŠ ä¸€é»è¾£",
      "ç¬¬äº”èª²,ç§Ÿå±‹åˆç´„æœ€çŸ­éœ€ä¸€å¹´å¯å¦æ¥å—"
    ];
    const csv="\uFEFF"+lines.join("\n");
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}), url=URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download="lesson_template.csv"; a.click(); URL.revokeObjectURL(url);
  }
</script>
</body>
</html>
