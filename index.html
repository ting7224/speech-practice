<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ä¸­æ–‡å£èªå³æ™‚æ¯”å°å°ç¨‹å¼</title>
  <style>
    body {
      font-family: "Microsoft JhengHei", Arial, sans-serif;
      background: #fafafa;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 860px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1 { text-align: center; color: #333; }
    select, button { padding: 8px 12px; margin: 5px; font-size: 16px; }
    .sentence {
      font-size: 20px; text-align: center; margin: 20px 0;
      padding: 10px; background: #f1f1f1; border-radius: 8px;
    }
    #result, #diff {
      padding: 10px; margin-top: 10px; background: #f9f9f9;
      border: 1px solid #ddd; min-height: 30px;
    }
    .row { margin: 6px 0; }
    .label { color:#666; font-size:14px; margin-right:6px; }
    .highlight { background: yellow; font-weight: bold; }
    .ok { background: rgba(22,163,74,.12); }
    .note { color:#6b7280; font-size:12px; }
    .scoreRow { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    #feedback { color:#374151; font-size:15px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ä¸­æ–‡å£èªå³æ™‚æ¯”å°</h1>

    <label for="topic">é¸æ“‡ä¸»é¡Œï¼š</label>
    <select id="topic">
      <option value="school">å­¸æ ¡</option>
      <option value="transport">äº¤é€š</option>
      <option value="shopping">è³¼ç‰©</option>
      <option value="food">é¤é£²</option>
      <option value="housing">ä½å®¿</option>
    </select>
    <button onclick="newSentence()">æ›ä¸€å¥</button>

    <div class="sentence" id="sentence">è«‹æŒ‰ã€Œæ›ä¸€å¥ã€ç”Ÿæˆå¥å­</div>

    <button onclick="playSentence()">ğŸ”Š ç¤ºç¯„ç™¼éŸ³</button>
    <button onclick="startRecognition()">ğŸ™ï¸ é–‹å§‹éŒ„éŸ³</button>

    <h3>è¾¨è­˜çµæœï¼š</h3>
    <div id="result">å°šç„¡çµæœ</div>

    <h3>å·®ç•°é«˜å…‰ï¼š</h3>
    <div id="diff">å°šç„¡çµæœ</div>
    <div class="note">èªªæ˜ï¼šç¶ åº•ç‚ºä¸€è‡´ï¼Œé«˜å…‰ç‚ºä¸åŒï¼›ä¾‹å¥ç¼ºæ¼ä»¥ <b>âˆ…</b> é¡¯ç¤ºï¼Œè¾¨è­˜å¤šå”¸æœƒåœ¨ã€Œè¾¨è­˜ã€è¡Œä»¥é«˜å…‰é¡¯ç¤ºã€‚</div>

    <h3>æ­£ç¢ºç‡ï¼š</h3>
    <div class="scoreRow">
      <div id="accuracy">â€”</div>
      <div id="feedback"></div>
      <button id="btnDownload" onclick="downloadTxt()">â¬‡ï¸ ä¸‹è¼‰æˆç¸¾ï¼ˆTXTï¼‰</button>
    </div>
  </div>

<script>
  // ---- å¥åº«ï¼šæ¯å€‹ä¸»é¡Œ 5 å¥ ----
  const sentences = {
    school: [
      "è«‹å•æˆ‘å¯ä»¥åœ¨å“ªè£¡è¾¦ç†åŠ é€€é¸",
      "åœ–æ›¸é¤¨ä»Šå¤©é–‹åˆ°å¹¾é»",
      "ä¸‹é€±çš„å°çµ„å ±å‘Šéœ€è¦ä¸Šè‡ºå ±å‘Šååˆ†é˜",
      "æ˜å¤©çš„é«”è‚²èª²è¦ç©¿é‹å‹•æœå’Œç™½è‰²çƒé‹",
      "äº¤æ›ç”Ÿèªªæ˜æœƒæ”¹åˆ°ä¸‹åˆä¸‰é»ï¼Œåˆ¥é²åˆ°äº†"
    ],
    transport: [
      "åˆ°è‡ºåŒ—è»Šç«™è¦åœ¨å“ªè£¡æ­è»Š",
      "å…¬è»Šåˆ°ç«™è«‹å¾å¾Œé–€ä¸‹è»Šä¸è¦æ“ ",
      "é€™è¼›å…¬è»Šçš„æœ«ç­è»Šæ˜¯æ™šä¸Šåä¸€é»",
      "ä½ è¦ä¸‹è»Šè¦è¨˜å¾—æ—©ä¸€é»æŒ‰ä¸‹è»Šéˆ´",
      "æ­é«˜éµè‡ªç”±åº§éœ€è¦å…ˆæ’éšŠç­‰è»Š"
    ],
    shopping: [
      "é€™ä»¶å¤–å¥—å¤ªå¤§äº†æœ‰æ²’æœ‰å°ä¸€è™Ÿçš„",
      "é€™æ˜¯ç‰¹åƒ¹å•†å“ä¸å¯ä»¥é€€æ›å–”",
      "è«‹å•æˆ‘å¯ä»¥ä½¿ç”¨è¡Œå‹•æ”¯ä»˜æˆ–æ˜¯ä¿¡ç”¨å¡å—",
      "ä½ æœ‰æœƒå“¡æˆ–è¼‰å…·å—",
      "ä½ å·²ç¶“ç¢ºèªå°ºå¯¸å’Œé¡è‰²äº†å—"
    ],
    food: [
      "è«‹ä¸è¦åŠ é¦™èœè¬è¬å¦å¤–åŠ ä¸€é»è¾£",
      "è«‹å•ä½ è¦å…§ç”¨é‚„æ˜¯å¤–å¸¶",
      "æˆ‘è¦é»ç‰›è‚‰éºµå’Œå†°ç´…èŒ¶å…§ç”¨ä¸‰è™Ÿæ¡Œ",
      "é€™å®¶é¤å»³çš„æ‹›ç‰Œèœæ˜¯å°ç± åŒ…å’Œç‚’é£¯",
      "æˆ‘è¦ä¸€æ¯å†°ç´…èŒ¶åŠç³–å»å†°"
    ],
    housing: [
      "æˆ‘é€™å€‹å­¸æœŸä¸ä½åœ¨å®¿èˆè¦åœ¨å­¸æ ¡é™„è¿‘ç§Ÿæˆ¿å­",
      "æ°´é›»å¦å¤–ç®—é‚„æœ‰æ¯æœˆè¦äº¤ç®¡ç†è²»ä¸€ç™¾å…ƒ",
      "é€™å€‹æˆ¿é–“éœ€è¦ä»˜æŠ¼é‡‘å…©å€‹æœˆé€€ç§Ÿæ™‚æœƒé‚„çµ¦ä½ ",
      "é€™è£¡ä¸å¯ä»¥é¤Šå¯µç‰©ä¹Ÿä¸å¯ä»¥ç”¨æ˜ç«ç…®æ±è¥¿",
      "åƒåœ¾éœ€è¦åˆ†é¡æ‰å¯ä»¥ä¸Ÿåˆ°åƒåœ¾æ¡¶"
    ]
  };

  let currentSentence = "";
  const records = []; // ç”¨ä¾†ç´¯ç©æ¯æ¬¡ç·´ç¿’çš„æˆç¸¾

  function nowString(){
    const t = new Date();
    const pad = n => String(n).padStart(2,'0');
    return `${t.getFullYear()}-${pad(t.getMonth()+1)}-${pad(t.getDate())} ${pad(t.getHours())}:${pad(t.getMinutes())}:${pad(t.getSeconds())}`;
  }

  function newSentence() {
    const topic = document.getElementById("topic").value;
    const list = sentences[topic];
    currentSentence = list[Math.floor(Math.random() * list.length)];
    document.getElementById("sentence").innerText = currentSentence;
    document.getElementById("result").innerText = "å°šç„¡çµæœ";
    document.getElementById("diff").innerText = "å°šç„¡çµæœ";
    document.getElementById("accuracy").innerText = "â€”";
    document.getElementById("feedback").innerText = "";
  }

  // ç¤ºç¯„ç™¼éŸ³
  function playSentence() {
    if (!currentSentence) { alert("è«‹å…ˆç”Ÿæˆå¥å­ï¼"); return; }
    const u = new SpeechSynthesisUtterance(currentSentence);
    u.lang = "zh-TW";
    speechSynthesis.cancel(); speechSynthesis.speak(u);
  }

  // ---- èªéŸ³è¾¨è­˜ï¼ˆChromeï¼‰----
  function startRecognition() {
    if (!('webkitSpeechRecognition' in window)) {
      alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼Œè«‹ä½¿ç”¨ Chromeã€‚");
      return;
    }
    if (!currentSentence) {
      alert("è«‹å…ˆæŒ‰ã€Œæ›ä¸€å¥ã€ç”Ÿæˆå¥å­ï¼");
      return;
    }
    const recognition = new webkitSpeechRecognition();
    recognition.lang = "zh-TW";
    recognition.continuous = false;
    recognition.interimResults = false;

    recognition.start();
    recognition.onresult = function(event) {
      const resultText = event.results[0][0].transcript;
      document.getElementById("result").innerText = resultText;
      const { pct, feedbackText } = renderDiffAndScore(currentSentence, resultText);

      // è¨˜éŒ„
      const topicSel = document.getElementById("topic");
      const topicName = topicSel.options[topicSel.selectedIndex].text;
      records.push({
        time: nowString(),
        topic: topicName,
        sentence: currentSentence,
        recognized: resultText,
        accuracy: pct,
        feedback: feedbackText
      });
    };
  }

  // ---- å·¥å…·ï¼šæ­£è¦åŒ–ï¼ˆå»ç©ºç™½èˆ‡æ¨™é»ã€å…¨å½¢è½‰åŠå½¢ï¼‰----
  function normalize(str){
    if(!str) return "";
    return str
      .replace(/[\s\p{P}\p{S}]/gu,'')
      .replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
  }

  // ---- Levenshtein + å›æº¯ï¼Œè¼¸å‡ºé›™ç«¯é«˜å…‰ ----
  function diffAlign(aRaw, bRaw){
    const a = normalize(aRaw);
    const b = normalize(bRaw);
    const n=a.length, m=b.length;
    const dp = Array.from({length:n+1},()=>Array(m+1).fill(0));
    const bt = Array.from({length:n+1},()=>Array(m+1).fill(null));
    for(let i=0;i<=n;i++){ dp[i][0]=i; bt[i][0]='U'; }
    for(let j=0;j<=m;j++){ dp[0][j]=j; bt[0][j]='L'; }
    for(let i=1;i<=n;i++){
      for(let j=1;j<=m;j++){
        const cost = a[i-1]===b[j-1]?0:1;
        const d = dp[i-1][j-1] + cost; // ä»£æ›¿/ç›¸åŒ
        const u = dp[i-1][j] + 1;      // åˆªé™¤ a
        const l = dp[i][j-1] + 1;      // æ’å…¥ b
        const best = Math.min(d,u,l);
        dp[i][j]=best; bt[i][j] = best===d? 'D' : best===u? 'U' : 'L';
      }
    }
    // å›æº¯
    let i=n, j=m, ops=[];
    while(i>0 || j>0){
      const move=bt[i][j];
      if(move==='D'){
        ops.push({type: a[i-1]===b[j-1]?'EQ':'SUB', a:a[i-1], b:b[j-1]}); i--; j--;
      }else if(move==='U'){
        ops.push({type:'DEL', a:a[i-1], b:''}); i--;
      }else{
        ops.push({type:'INS', a:'', b:b[j-1]}); j--;
      }
    }
    ops.reverse();
    return {distance: dp[n][m], ops, baseLen: Math.max(1,a.length)};
  }

  function feedbackByScore(pct){
    if (pct >= 95) return "å¤ªæ£’äº†ï¼å¹¾ä¹å®Œå…¨æ­£ç¢ºï¼Œç¶­æŒæ¸…æ™°çš„å’¬å­—èˆ‡ç©©å®šçš„èªé€Ÿã€‚";
    if (pct >= 85) return "å¾ˆä¸éŒ¯ï¼å†æ³¨æ„å€‹åˆ¥å­—çš„æ”¶å°¾èˆ‡é€£éŸ³ï¼Œæ”¾æ…¢ä¸€é»æ›´ç©©ã€‚";
    if (pct >= 70) return "æœ‰é€²æ­¥ï¼å»ºè­°è·Ÿè‘—ç¤ºç¯„æ…¢é€Ÿæœ—è®€ä¸€æ¬¡ï¼Œæ³¨æ„å®¹æ˜“æ··æ·†çš„å­—ã€‚";
    if (pct >= 50) return "åˆ¥æ€¥ï¼Œå…ˆåˆ†æ®µæœ—è®€ä¸¦é‡è¤‡ç·´å…©æ¬¡ï¼Œå†ä¸€æ¬¡å®Œæ•´æœ—è®€ã€‚";
    return "åŠ æ²¹ï¼å…ˆè½ç¤ºç¯„å…©éï¼Œé€å­—è·Ÿè®€ï¼Œç¢ºèªæ¯å€‹å­—éƒ½æœ‰ç™¼åˆ°ä½ã€‚";
  }

  function renderDiffAndScore(targetRaw, heardRaw){
    const {distance, ops, baseLen} = diffAlign(targetRaw, heardRaw);
    const partsA = []; // ä¾‹å¥
    const partsB = []; // è¾¨è­˜
    for(const op of ops){
      if(op.type==='EQ'){
        partsA.push(`<span class="ok">${op.a}</span>`);
        partsB.push(`<span class="ok">${op.b}</span>`);
      }else if(op.type==='SUB'){
        partsA.push(`<span class="highlight" title="æ‡‰ç‚ºï¼š${op.a}">${op.a}</span>`);
        partsB.push(`<span class="highlight" title="è¾¨ç‚ºï¼š${op.b}">${op.b}</span>`);
      }else if(op.type==='DEL'){ // ä¾‹å¥æœ‰ã€è¾¨è­˜æ¼
        partsA.push(`<span class="highlight" title="æœªå”¸å‡ºï¼š${op.a}">${op.a}</span>`);
        partsB.push(`<span class="highlight" title="æœªå”¸å‡º">âˆ…</span>`);
      }else if(op.type==='INS'){ // ä¾‹å¥ç„¡ã€è¾¨è­˜å¤š
        partsA.push(`<span class="highlight" title="å¤šå”¸">${'âˆ…'}</span>`);
        partsB.push(`<span class="highlight" title="å¤šå”¸ï¼š${op.b}">${op.b}</span>`);
      }
    }
    const html =
      `<div class="row"><span class="label">ä¾‹å¥ï¼š</span>${partsA.join('')}</div>`+
      `<div class="row"><span class="label">è¾¨è­˜ï¼š</span>${partsB.join('')}</div>`;
    document.getElementById("diff").innerHTML = html;

    // åˆ†æ•¸ï¼ˆä»¥ä¾‹å¥é•·åº¦ç‚ºåŸºæº–ï¼‰
    const acc = Math.max(0, 1 - distance / baseLen);
    const pct = Math.round(acc*100);
    document.getElementById("accuracy").innerText = pct + "%";

    const fb = feedbackByScore(pct);
    document.getElementById("feedback").innerText = fb;

    return { pct, feedbackText: fb };
  }

  // ---- ä¸‹è¼‰ TXT æˆç¸¾ ----
  function downloadTxt(){
    if (records.length === 0) {
      alert("å°šç„¡æˆç¸¾å¯ä¸‹è¼‰ã€‚è«‹å…ˆå®Œæˆä¸€æ¬¡éŒ„éŸ³ç·´ç¿’ã€‚");
      return;
    }
    const lines = [];
    lines.push("ã€ä¸­æ–‡å£èªå³æ™‚æ¯”å°ï½œæˆç¸¾å–®ã€‘");
    lines.push(`åŒ¯å‡ºæ™‚é–“ï¼š${nowString()}`);
    lines.push("");
    lines.push("æ™‚é–“\tä¸»é¡Œ\tä¾‹å¥\tè¾¨è­˜çµæœ\tæ­£ç¢ºç‡(%)\tå»ºè­°èˆ‡å›é¥‹");

    for (const r of records) {
      // ä»¥ TAB åˆ†éš”ï¼Œé¿å…é€—è™Ÿæ··æ·†ï¼›æ›è¡Œçµ±ä¸€æ›¿æ›ç©ºç™½
      const clean = s => (s||"").replace(/\r?\n/g," ").trim();
      lines.push(
        `${r.time}\t${clean(r.topic)}\t${clean(r.sentence)}\t${clean(r.recognized)}\t${r.accuracy}\t${clean(r.feedback)}`
      );
    }

    const content = lines.join("\n");
    const blob = new Blob(["\uFEFF" + content], {type: "text/plain;charset=utf-8;"}); // åŠ  BOMï¼ŒWindows è¨˜äº‹æœ¬ä¸æœƒäº‚ç¢¼
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "speaking_results.txt"; a.click();
    URL.revokeObjectURL(url);
  }
</script>
</body>
</html>
